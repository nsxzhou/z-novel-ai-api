# 02 - 配置管理与环境变量规范

> AI 小说生成后端配置文件结构、环境变量命名及密钥管理规范

## 1. 概述

本文档定义了项目的配置管理策略，包括配置文件结构、环境变量命名规范、密钥安全管理以及热更新机制。遵循"配置即代码"原则，确保配置的版本化、安全性与可审计性。

---

## 2. 配置分层策略

```mermaid
graph TD
    A[默认配置 config.yaml] --> B[环境配置 config.{env}.yaml]
    B --> C[环境变量 ENV]
    C --> D[密钥注入 Vault/KMS]
    D --> E[最终配置]

    style D fill:#f96,stroke:#333
```

**加载优先级**（由低到高）：

1. `configs/config.yaml` - 默认配置
2. `configs/config.{ENV}.yaml` - 环境特定配置
3. 环境变量 - 覆盖配置文件
4. Vault/KMS 注入 - 敏感信息

---

## 3. 配置文件结构

### 3.1 主配置文件 `config.yaml`

```yaml
# configs/config.yaml
app:
  name: "z-novel-ai-api"
  version: "${VERSION:v0.0.0}"
  env: "${APP_ENV:development}"

server:
  http:
    host: "0.0.0.0"
    port: 8080
    read_timeout: 30s
    write_timeout: 60s
    idle_timeout: 120s
  grpc:
    host: "0.0.0.0"
    port: 9090
    max_recv_msg_size: 16777216 # 16MB
    max_send_msg_size: 16777216

database:
  postgres:
    host: "${DB_HOST:localhost}"
    port: ${DB_PORT:5432}
    user: "${DB_USER:postgres}"
    password: "${DB_PASSWORD}" # 必须通过 Vault 注入
    database: "${DB_NAME:z_novel_ai}"
    ssl_mode: "disable"
    max_open_conns: 50
    max_idle_conns: 10
    conn_max_lifetime: 30m
    conn_max_idle_time: 5m

cache:
  redis:
    host: "${REDIS_HOST:localhost}"
    port: ${REDIS_PORT:6379}
    password: "${REDIS_PASSWORD}" # 通过 Vault 注入
    db: 0
    pool_size: 100
    min_idle_conns: 10
    dial_timeout: 5s
    read_timeout: 3s
    write_timeout: 3s

vector:
  milvus:
    host: "${MILVUS_HOST:localhost}"
    port: ${MILVUS_PORT:19530}
    user: "${MILVUS_USER}"
    password: "${MILVUS_PASSWORD}" # 通过 Vault 注入
    collection_prefix: "z_novel"
    index_type: "HNSW"
    metric_type: "COSINE"
    hnsw_m: 16
    hnsw_ef_construction: 200

storage:
  r2:
    endpoint: "${R2_ENDPOINT:localhost:9000}"
    region: "${R2_REGION:us-east-1}"
    access_key: "${R2_ACCESS_KEY}" # 通过 Vault 注入
    secret_key: "${R2_SECRET_KEY}" # 通过 Vault 注入
    bucket: "${R2_BUCKET:z-novel-ai}"
    use_ssl: false

llm:
  default_provider: "openai"
  providers:
    openai:
      api_key: "${OPENAI_API_KEY}" # 通过 Vault 注入
      base_url: "https://api.openai.com/v1"
      model: "gpt-4o"
      max_tokens: 8192
      temperature: 0.7
      timeout: 120s
    deepseek:
      api_key: "${DEEPSEEK_API_KEY}" # 通过 Vault 注入
      base_url: "https://api.deepseek.com"
      model: "deepseek-chat"
      max_tokens: 8192
      temperature: 0.7
      timeout: 120s
  fallback_chain: # 降级链
    - "openai"
    - "deepseek"

embedding:
  provider: "local"
  model: "BAAI/bge-m3"
  dimension: 1024
  batch_size: 32
  endpoint: "${EMBEDDING_ENDPOINT:http://localhost:8000}"

messaging:
  redis_stream:
    max_len: 100000
    consumer_group_prefix: "cg"
    block_timeout: 5s
    claim_interval: 30s
    retry_limit: 3
    retry_backoff:
      initial: 1s
      max: 60s
      multiplier: 2

observability:
  logging:
    level: "${LOG_LEVEL:info}"
    format: "json"
    output: "stdout"
  tracing:
    enabled: true
    exporter: "otlp"
    endpoint: "${OTLP_ENDPOINT:localhost:4317}"
    sample_rate: 1.0
  metrics:
    enabled: true
    port: 9091
    path: "/metrics"

security:
  jwt:
    secret: "${JWT_SECRET}" # 通过 Vault 注入
    issuer: "z-novel-ai"
    expiration: 24h
    refresh_expiration: 168h # 7 days
  rate_limit:
    enabled: true
    requests_per_second: 100
    burst: 200
  cors:
    allowed_origins:
      - "*"
    allowed_methods:
      - "GET"
      - "POST"
      - "PUT"
      - "DELETE"
    allowed_headers:
      - "Authorization"
      - "Content-Type"
      - "X-Request-ID"
      - "Idempotency-Key"

features:
  validation:
    enabled: true
    default_pass_on_failure: true
  memory_writeback:
    enabled: true
    async: true
```

### 3.2 环境特定配置

```yaml
# configs/config.prod.yaml
# 生产环境覆盖配置

server:
  http:
    port: 80

database:
  postgres:
    ssl_mode: "require"
    max_open_conns: 100
    max_idle_conns: 25

cache:
  redis:
    pool_size: 200

observability:
  logging:
    level: "warn"
  tracing:
    sample_rate: 0.1

security:
  rate_limit:
    requests_per_second: 50
    burst: 100
  cors:
    allowed_origins:
      - "https://novel.example.com"
```

---

## 4. 环境变量命名规范

### 4.1 命名规则

| 前缀        | 用途          | 示例                           |
| ----------- | ------------- | ------------------------------ |
| `APP_`      | 应用配置      | `APP_ENV`, `APP_NAME`          |
| `DB_`       | 数据库配置    | `DB_HOST`, `DB_PASSWORD`       |
| `REDIS_`    | Redis 配置    | `REDIS_HOST`, `REDIS_PASSWORD` |
| `MILVUS_`   | 向量库配置    | `MILVUS_HOST`, `MILVUS_PORT`   |
| `R2_`       | 对象存储配置  | `R2_ENDPOINT`, `R2_BUCKET`     |
| `OPENAI_`   | OpenAI 配置   | `OPENAI_API_KEY`               |
| `DEEPSEEK_` | DeepSeek 配置 | `DEEPSEEK_API_KEY`             |
| `JWT_`      | JWT 配置      | `JWT_SECRET`                   |
| `LOG_`      | 日志配置      | `LOG_LEVEL`                    |
| `OTLP_`     | 追踪配置      | `OTLP_ENDPOINT`                |

### 4.2 敏感变量标识

以下环境变量**必须**通过 Vault/KMS 注入，禁止硬编码或明文存储：

```bash
# 敏感变量清单
DB_PASSWORD
REDIS_PASSWORD
MILVUS_PASSWORD
R2_ACCESS_KEY
R2_SECRET_KEY
OPENAI_API_KEY
DEEPSEEK_API_KEY
JWT_SECRET
```

---

## 5. 密钥管理（Vault）

### 5.1 Vault 路径规范

```
secret/
└── z-novel-ai/
    ├── common/           # 通用密钥
    │   ├── jwt_secret
    │   └── encryption_key
    ├── database/
    │   ├── postgres_password
    │   ├── redis_password
    │   └── milvus_password
    ├── storage/
    │   ├── r2_access_key
    │   └── r2_secret_key
    └── llm/
        ├── openai_api_key
        └── deepseek_api_key
```

### 5.2 Vault Agent 配置

```hcl
# vault-agent-config.hcl
auto_auth {
  method "kubernetes" {
    mount_path = "auth/kubernetes"
    config = {
      role = "z-novel-ai"
    }
  }

  sink "file" {
    config = {
      path = "/vault/secrets/.token"
    }
  }
}

template {
  source      = "/vault/templates/env.ctmpl"
  destination = "/vault/secrets/env"
}
```

### 5.3 环境变量模板

```bash
# /vault/templates/env.ctmpl
{{ with secret "secret/z-novel-ai/database" }}
DB_PASSWORD={{ .Data.data.postgres_password }}
REDIS_PASSWORD={{ .Data.data.redis_password }}
{{ end }}

{{ with secret "secret/z-novel-ai/llm" }}
OPENAI_API_KEY={{ .Data.data.openai_api_key }}
DEEPSEEK_API_KEY={{ .Data.data.deepseek_api_key }}
{{ end }}

{{ with secret "secret/z-novel-ai/common" }}
JWT_SECRET={{ .Data.data.jwt_secret }}
{{ end }}
```

---

## 6. 配置加载实现

### 6.1 配置结构定义

```go
// internal/config/config.go
package config

import (
    "time"
)

type Config struct {
    App           AppConfig           `yaml:"app"`
    Server        ServerConfig        `yaml:"server"`
    Database      DatabaseConfig      `yaml:"database"`
    Cache         CacheConfig         `yaml:"cache"`
    Vector        VectorConfig        `yaml:"vector"`
    Storage       StorageConfig       `yaml:"storage"`
    LLM           LLMConfig           `yaml:"llm"`
    Embedding     EmbeddingConfig     `yaml:"embedding"`
    Messaging     MessagingConfig     `yaml:"messaging"`
    Observability ObservabilityConfig `yaml:"observability"`
    Security      SecurityConfig      `yaml:"security"`
    Features      FeaturesConfig      `yaml:"features"`
}

type AppConfig struct {
    Name    string `yaml:"name" env:"APP_NAME"`
    Version string `yaml:"version" env:"VERSION"`
    Env     string `yaml:"env" env:"APP_ENV"`
}

type ServerConfig struct {
    HTTP HTTPServerConfig `yaml:"http"`
    GRPC GRPCServerConfig `yaml:"grpc"`
}

type HTTPServerConfig struct {
    Host         string        `yaml:"host"`
    Port         int           `yaml:"port" env:"HTTP_PORT"`
    ReadTimeout  time.Duration `yaml:"read_timeout"`
    WriteTimeout time.Duration `yaml:"write_timeout"`
    IdleTimeout  time.Duration `yaml:"idle_timeout"`
}

// ... 其他配置结构
```

### 6.2 配置加载器

```go
// internal/config/loader.go
package config

import (
    "os"
    "github.com/spf13/viper"
)

func Load() (*Config, error) {
    v := viper.New()

    // 设置默认配置文件
    v.SetConfigName("config")
    v.SetConfigType("yaml")
    v.AddConfigPath("./configs")
    v.AddConfigPath("/etc/z-novel-ai")

    // 读取默认配置
    if err := v.ReadInConfig(); err != nil {
        return nil, err
    }

    // 读取环境特定配置
    env := os.Getenv("APP_ENV")
    if env != "" {
        v.SetConfigName("config." + env)
        _ = v.MergeInConfig()
    }

    // 绑定环境变量
    v.AutomaticEnv()
    v.SetEnvPrefix("")

    // 解析配置
    var cfg Config
    if err := v.Unmarshal(&cfg); err != nil {
        return nil, err
    }

    return &cfg, nil
}
```

---

## 7. 热更新机制

### 7.1 支持热更新的配置项

| 配置项                        | 热更新 | 说明       |
| ----------------------------- | ------ | ---------- |
| `observability.logging.level` | ✅     | 日志级别   |
| `security.rate_limit.*`       | ✅     | 限流参数   |
| `features.*`                  | ✅     | 功能开关   |
| `llm.fallback_chain`          | ✅     | 模型降级链 |
| `database.*`                  | ❌     | 需重启     |
| `server.*`                    | ❌     | 需重启     |

### 7.2 热更新实现

```go
// internal/config/watcher.go
package config

import (
    "context"
    "sync/atomic"
    "github.com/fsnotify/fsnotify"
)

type DynamicConfig struct {
    LogLevel        atomic.Value // string
    RateLimitRPS    atomic.Int64
    RateLimitBurst  atomic.Int64
    ValidationOn    atomic.Bool
    FallbackChain   atomic.Value // []string
}

func (c *DynamicConfig) Watch(ctx context.Context, configPath string) error {
    watcher, err := fsnotify.NewWatcher()
    if err != nil {
        return err
    }

    go func() {
        defer watcher.Close()
        for {
            select {
            case <-ctx.Done():
                return
            case event := <-watcher.Events:
                if event.Op&fsnotify.Write == fsnotify.Write {
                    c.reload(configPath)
                }
            }
        }
    }()

    return watcher.Add(configPath)
}
```

---

## 8. 多环境配置清单

| 环境          | 配置文件              | 特点                        |
| ------------- | --------------------- | --------------------------- |
| `development` | `config.dev.yaml`     | 调试日志、无限流、Mock 服务 |
| `staging`     | `config.staging.yaml` | 模拟生产、采样追踪          |
| `production`  | `config.prod.yaml`    | 高性能、严格安全、低日志    |

---

## 9. 相关文档

- [01-项目初始化与目录结构规范](./01-项目初始化与目录结构规范.md)
- [03-日志与可观测性规范](./03-日志与可观测性规范.md)
- [19-安全与多租户隔离设计](./19-安全与多租户隔离设计.md)
