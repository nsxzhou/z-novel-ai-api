# 21 - 对话驱动小说生成系统技术规范

更新时间：2026-01-06

> 本文档是"对话驱动小说创作"功能的完整技术规范，整合了实施记录与演进路线图。涵盖从项目孵化、设定生成到版本管理的全链路设计。

---

## 1. 功能全景与模块状态

### 1.1 已完成模块 (Completed)

| 模块                           | 描述                                               | 核心入口                      |
| :----------------------------- | :------------------------------------------------- | :---------------------------- |
| **项目孵化 (ProjectCreation)** | 通过 4 阶段对话引导用户从模糊想法转化为正式项目    | `handler/project_creation.go` |
| **长期会话 (Conversation)**    | 支持在已有项目上进行多轮对话，切换任务迭代设定集   | `handler/conversation.go`     |
| **构件版本化 (Artifact)**      | 世界观/角色/大纲作为独立资产，支持多版本与一键回滚 | `handler/artifact.go`         |
| **一揽子生成 (Foundation)**    | 一次性生成完整设定包（Plan -> Validate -> Apply）  | `handler/foundation.go`       |
| **Token 配额治理**             | 租户级日配额预检与使用量统计                       | `quota/token_quota.go`        |
| **异步任务 (Jobs)**            | Redis Streams + Worker 执行长耗时生成              | `cmd/job-worker/main.go`      |

### 1.2 待完成模块 (In Progress / Planned)

| 模块                | 描述                                 | 优先级 |
| :------------------ | :----------------------------------- | :----- |
| **增量 Patch 模式** | 支持 AI 仅输出变更部分，而非全量替换 | P1     |
| **上下文自动摘要**  | 当会话过长时自动压缩历史，节省 Token | P1     |
| **设定冲突扫描**    | 检测新生成内容与已有设定的矛盾       | P2     |
| **多分支创作**      | 支持同一节点的 A/B 版本对比          | P2     |
| **章节生成闭环**    | 补齐章节正文的同步/SSE/异步生成路径  | P1     |
| **检索服务 (RAG)**  | 实现向量检索与上下文召回             | P2     |

---

## 2. 核心能力路径详解

### 2.1 路径 A：项目孵化（从无到有）

**适用场景**：用户有模糊想法，通过对话逐步明确立项。

**API 入口**：

- `POST /v1/project-creation-sessions`: 创建孵化会话。
- `POST /v1/project-creation-sessions/:sid/messages`: 发送对话指令。

**技术流程**：

1. 用户进入"探索"阶段（discover），AI 通过引导性问题挖掘想法。
2. 进入"细化"阶段（narrow），AI 帮助用户确定题材、基调。
3. 进入"草稿"阶段（draft），AI 生成标题与简介。
4. 用户明确确认后，系统自动创建 Project 并关联长期会话。

**实现文件**：

- `internal/interfaces/http/handler/project_creation.go`
- `internal/application/story/project_creation_generator.go`
- `internal/domain/entity/project_creation.go`

---

### 2.2 路径 B：设定迭代（长期会话驱动）

**适用场景**：在已有项目基础上，通过对话反复打磨设定。

**API 入口**：

- `POST /v1/projects/:pid/sessions`: 创建长期会话。
- `POST /v1/projects/:pid/sessions/:sid/messages`: 发送指令并指定任务类型。
- `POST /v1/projects/:pid/artifacts/:aid/rollback`: 回滚到历史版本。

**任务类型（Task）**：

- `novel_foundation`: 小说基底（标题 + 简介）。
- `worldview`: 世界观设定。
- `characters`: 角色与关系网络。
- `outline`: 卷章大纲。

**技术流程**：

1. 系统加载"当前激活版本"的所有构件作为 AI 的背景上下文。
2. AI 结合用户指令产出新版本的完整 JSON。
3. 系统通过 `ai_key` 精准映射，将新版本入库。
4. 用户不满意可回滚到任意历史版本。

**实现文件**：

- `internal/interfaces/http/handler/conversation.go`
- `internal/application/story/artifact_generator.go`
- `internal/interfaces/http/handler/artifact.go`

---

### 2.3 路径 C：一揽子生成（Foundation 初始化）

**适用场景**：项目冷启动，一次性生成全量设定包。

**API 入口**：

- `POST /v1/projects/:pid/foundation/preview`: 同步生成 Plan。
- `GET|POST /v1/projects/:pid/foundation/stream`: SSE 流式生成。
- `POST /v1/projects/:pid/foundation/generate`: 异步生成（返回 Job ID）。
- `POST /v1/projects/:pid/foundation/apply`: 将 Plan 落库。

**实现文件**：

- `internal/interfaces/http/handler/foundation.go`
- `internal/application/story/foundation_generator.go`
- `internal/application/story/foundation_apply.go`

---

## 3. 技术架构关键选型

### 3.1 "项目创建会话"为何使用独立表？

- **数据解耦**：孵化期的草稿数据与正式项目资产物理隔离。
- **外键纯粹性**：正式会话表 `conversation_sessions.project_id` 保持 `NOT NULL` 约束。
- **清理便捷**：可按策略定期清理未完成的孵化草稿。

### 3.2 为何采用"全量快照"而非"局部 Patch"？

- **LLM 稳定性**：模型对全量 JSON 的理解和产出质量远高于 Patch/Diff 语法。
- **回滚极速**：仅需一次 `active_version_id` 指针更新。
- **调试友好**：每个版本都是完整可读的状态。

### 3.3 `ai_key` 稳定映射策略

- 解决问题：AI 输出顺序不稳定导致的数据错位。
- 方案：所有构件（Entity/Volume/Chapter）引入 `ai_key` 字段，后端按 Key 精准 Upsert。

---

## 4. 落库规则与校验约束

### 4.1 Plan 校验（必须做）

- **Key 唯一性**：`entities[].key`, `volumes[].key`, `chapters[].key` 不得重复。
- **引用完整性**：`relations[].source_key/target_key` 必须存在于 `entities[].key`。
- **枚举合法性**：`entity.type`, `entity.importance`, `relation.relation_type` 必须为预定义值。
- **长度限制**：`title/name` <= 255 字符，`outline/description` 做合理上限。

### 4.2 Apply 策略（幂等 Upsert）

- **Entities**：按 `(project_id, ai_key)` 做 Upsert。
- **Relations**：按 `(project_id, source_id, target_id, relation_type)` 去重更新。
- **Volumes/Chapters**：按 `ai_key` 匹配后重排 `seq_num`。

---

## 5. 后续路线图 (Roadmap)

### 第一阶段：精细化编辑 (Milestone 3)

- [ ] **增量 Patch 模式**：支持 AI 仅输出 `JSON Patch`。
- [ ] **上下文滚动摘要**：当轮次超过阈值时自动压缩历史。

### 第二阶段：质量实验室 (Milestone 4)

- [ ] **设定冲突扫描**：检测新生成内容与已有设定的矛盾并警告。
- [ ] **多分支创作**：支持同一节点的 A/B 版本并行与对比。

### 第三阶段：内容生成闭环 (Milestone 5)

- [ ] **章节生成**：补齐章节正文的同步/SSE/异步路径。
- [ ] **检索闭环**：实现 Milvus 向量检索与上下文召回。

---

## 附录：核心 API 索引

| 功能         | 入口                                               | 状态    |
| :----------- | :------------------------------------------------- | :------ |
| 对话式立项   | `POST /v1/project-creation-sessions`               | ✅ 就绪 |
| 发送孵化指令 | `POST /v1/project-creation-sessions/:sid/messages` | ✅ 就绪 |
| 创建长期会话 | `POST /v1/projects/:pid/sessions`                  | ✅ 就绪 |
| 发送任务指令 | `POST /v1/projects/:pid/sessions/:sid/messages`    | ✅ 就绪 |
| 构件回滚     | `POST /v1/projects/:pid/artifacts/:aid/rollback`   | ✅ 就绪 |
| 预览生成     | `POST /v1/projects/:pid/foundation/preview`        | ✅ 就绪 |
| 落库应用     | `POST /v1/projects/:pid/foundation/apply`          | ✅ 就绪 |
